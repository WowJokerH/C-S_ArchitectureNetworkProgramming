# C/S 网络通信系统

基于TCP/IP协议的客户端/服务器(C/S)网络程序设计项目。

## 功能特性

### 服务器端
1. ✅ **多客户端支持** - 同时接收并处理多个客户端连接
2. ✅ **连接监控** - 实时显示客户端IP地址、端口和连接状态
3. ✅ **数据接收** - 接收并显示客户端发送的数据
4. ✅ **协议验证** - 验证数据包合法性(起始字符、校验码、结束字符)
5. ✅ **间隔控制** - 通过响应包动态调整客户端发送间隔
6. ✅ **图形界面** - 专业的Qt GUI界面

### 客户端
1. ✅ **服务器连接** - 连接指定的服务器地址和端口
2. ✅ **数据发送** - 手动或自动定时发送数据
3. ✅ **自动重连** - 连接断开后自动重连
4. ✅ **间隔调整** - 接收服务器指令动态调整发送间隔
5. ✅ **通信统计** - 实时统计发送/接收数据包数量
6. ✅ **图形界面** - 简洁直观的Qt GUI界面

## 通信协议

### 数据包格式
```
[SOF(1)] [VERSION(1)] [LENGTH(2)] [PAYLOAD(n)] [CRC16(2)] [EOF(1)]
- 起始标记(SOF): 0xAA
- 版本(VERSION): 0x01
- 长度(LENGTH): 大端序16位整数，表示PAYLOAD字节数
- 负载数据(PAYLOAD): n字节业务数据
- CRC16校验: 对VERSION+LENGTH+PAYLOAD计算CRC16-CCITT（多项式0x1021）
- 结束标记(EOF): 0x55
```

### 负载格式
**客户端请求:**
```
[消息类型(1)] [消息ID(2)] [消息内容(n)]
```

**服务器响应:**
```
[响应码(1)] [时间戳(8)] [命令ID(1)] [命令参数(可选)]
- 响应码: 0x00=成功，0x01=失败
- 时间戳: 8字节毫秒时间戳(uint64)
- 命令ID: 0x00=无命令，0x01=设置发送间隔
- 命令参数: 当命令ID=0x01时，包含4字节间隔时间(毫秒，大端序)
```

## UI优化说明

### 服务器界面优化
- 🎨 **控制面板**: 清晰的端口配置、启动/停止按钮、实时状态指示器(绿色●运行/红色●停止)
- 📊 **连接列表**: 表格显示所有活动连接,包括ID、IP、端口、状态、收发统计
- ⚙️ **间隔控制**: 独立控制面板,可启用/禁用服务器端间隔强制控制
- 📝 **运行日志**: 等宽字体显示,带时间戳(精确到毫秒),分类标签([系统][数据][错误][配置])
- 🎯 **尺寸优化**: 默认1000x700窗口,合理的内容区域比例分配

### 客户端界面优化
- 🔌 **连接面板**: 服务器地址/端口配置,连接状态可视化指示器
- 📤 **发送控制**: 文本输入框、立即发送按钮、发送状态实时显示
- ⏱️ **自动发送**: 启用开关、间隔配置、服务器控制提示
- 📈 **统计信息**: 实时显示已发送/已接收数据包数量
- 📝 **通信日志**: 等宽字体,时间戳,分类日志([连接][发送][接收][错误][配置])
- 🎯 **尺寸优化**: 默认800x650窗口,各区域自适应布局

### 样式改进
- ✨ 专业配色方案(蓝色选中项、绿色成功状态、红色错误状态)
- 🔤 日志使用Consolas等宽字体,提升可读性
- 📐 组件间距统一(10px),边距合理
- 🎨 表格交替行颜色,网格线清晰可见
- 💡 工具提示(tooltip)说明复杂功能

## 编译和运行

### 构建项目
```bash
# 配置项目（需指定Qt安装路径）
cmake -S . -B build -DCMAKE_PREFIX_PATH=<Qt安装目录>

# 编译
cmake --build build --config Release
```

### 运行程序
```bash
# 启动服务器
.\build\src\server\server.exe

# 启动客户端
.\build\src\client\client.exe
```

**注意**：首次运行可能需要使用 `windeployqt` 部署Qt依赖库。

## 测试场景

1. **基本通信**: 启动服务器→启动客户端→连接→发送数据→查看响应
2. **多客户端**: 启动多个客户端实例，验证服务器同时处理能力
3. **自动发送**: 启用客户端自动发送，观察定时数据传输
4. **间隔控制**: 服务器端启用强制间隔，观察客户端间隔自动调整
5. **断线重连**: 停止服务器→观察客户端自动重连→重启服务器→验证重连成功
6. **非法数据测试**: 运行 `python test_invalid_packets.py` 验证服务器异常处理能力
   - ✅ 错误的起始标记 (非0xAA)
   - ✅ 错误的结束标记 (非0x55)
   - ✅ 错误的CRC16校验码
   - ✅ 长度字段不匹配（过长或过短）
   - ✅ 不完整的数据帧
   - ✅ 额外的字节
   - ✅ 缺少CRC校验
   - ✅ 错误的协议版本
   - ✅ 测试结果: **10/10 全部通过** ✓

---

详细设计（类图、线程模型、协议示例、测试计划）见 `docs/` 目录。

1. **基本通信**: 启动服务器→启动客户端→连接→发送数据→查看响应
2. **多客户端**: 启动多个客户端实例，验证服务器同时处理能力
3. **自动发送**: 启用客户端自动发送，观察定时数据传输
4. **间隔控制**: 服务器端启用强制间隔，观察客户端间隔自动调整
5. **断线重连**: 停止服务器→观察客户端自动重连→重启服务器→验证重连成功
6. **非法数据**: 运行 `python test_invalid_packets.py` 测试服务器对以下异常数据的识别能力:
   - ✅ 错误的起始标记 (非0xAA)
   - ✅ 错误的结束标记 (非0x55)
   - ✅ 错误的CRC16校验码
   - ✅ 长度字段不匹配（过长或过短）
   - ✅ 不完整的数据帧
   - ✅ 额外的字节
   - ✅ 缺少CRC校验
   - ✅ 错误的协议版本
   - ✅ 服务器正确拒绝所有非法数据包并记录错误日志
   - ✅ 测试结果: 10/10测试通过

## 技术栈

- **语言**: C++17
- **框架**: Qt 6 (Qt Widgets/QtNetwork)
- **网络**: QTcpServer, QTcpSocket
- **构建**: CMake + Ninja
- **平台**: Windows (可跨平台到Linux)

## 目录结构

```
docs/
  architecture.md    # 系统架构设计
  protocol.md        # 通信协议规范
  implementation.md  # 实现细节说明
  testing.md         # 测试计划与结果
resources/
src/
  common/            # 协议、CRC、日志公共组件
  server/            # Qt Widgets 服务器程序
  client/            # Qt Widgets 客户端程序
build/               # 构建输出目录
  src/
    server/server.exe    # 服务器可执行文件
    client/client.exe    # 客户端可执行文件
```

## 编译和运行

```bash
cmake -S . -B build -DCMAKE_PREFIX_PATH=<Qt安装目录>
cmake --build build
```

产物位于 `build/src/server/server` 与 `build/src/client/client`（Windows 下附 `.exe`）。运行前请确保 Qt 运行时已通过 `windeployqt`/`macdeployqt` 等工具部署。

详细设计（类图、线程模型、协议示例、测试计划）见 `docs`。
